#ifndef $name_macro_case$_MESSAGE_H
#define $name_macro_case$_MESSAGE_H

#include "../../../C/Ximu3.h"
#include <Python.h>

typedef struct {
    PyObject_HEAD
    XIMU3_$name_pascal_case$Message message;
} $name_pascal_case$Message;

static void $name_snake_case$_message_free($name_pascal_case$Message *self) {
    Py_TYPE(self)->tp_free(self);
}

$get_functions$

$method_functions$

static PyGetSetDef $name_snake_case$_message_get_set[] = {
    $get_set_members$
    {NULL} /* sentinel */
};

static PyMethodDef $name_snake_case$_message_methods[] = {
    $method_members$
    {NULL} /* sentinel */
};

static PyTypeObject $name_snake_case$_message_object = {
    PyVarObject_HEAD_INIT(NULL, 0)
    .tp_name = "ximu3.$name_pascal_case$Message",
    .tp_basicsize = sizeof($name_pascal_case$Message),
    .tp_dealloc = (destructor) $name_snake_case$_message_free,
    .tp_flags = Py_TPFLAGS_DEFAULT,
    .tp_getset = $name_snake_case$_message_get_set,
    .tp_methods = $name_snake_case$_message_methods,
};

static PyObject *$name_snake_case$_message_from(const XIMU3_$name_pascal_case$Message *const message) {
    $name_pascal_case$Message *const self = ($name_pascal_case$Message *) $name_snake_case$_message_object.tp_alloc(&$name_snake_case$_message_object, 0);

    if (self == NULL) {
        return NULL;
    }

    self->message = *message;
    return (PyObject *) self;
}

static void $name_snake_case$_message_callback(XIMU3_$name_pascal_case$Message data, void *context) {
    PyObject *object = NULL;
    PyObject *tuple = NULL;
    PyObject *result = NULL;

    const PyGILState_STATE state = PyGILState_Ensure();

    object = $name_snake_case$_message_from(&data);

    if (object == NULL) {
        PyErr_Print();
        goto cleanup;
    }

    tuple = PyTuple_Pack(1, object);

    if (tuple == NULL) {
        PyErr_Print();
        goto cleanup;
    }

    result = PyObject_CallObject((PyObject *) context, tuple);

    if (result == NULL) {
        PyErr_Print();
    }

cleanup:
    Py_XDECREF(object);
    Py_XDECREF(tuple);
    Py_XDECREF(result);

    PyGILState_Release(state);
}

#endif
